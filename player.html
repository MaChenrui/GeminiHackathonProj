<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç©å®¶ç«¯ â€“ Gemini è’™çœ¼ç«é€Ÿ</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;padding:16px}
  h1{text-align:center;font-size:1.4rem;margin-bottom:12px;color:#a78bfa}
  .card{background:#1e293b;border-radius:12px;padding:16px;margin-bottom:12px}
  label{display:block;font-size:.8rem;color:#94a3b8;margin-bottom:4px}
  input,textarea{width:100%;background:#0f172a;border:1px solid #334155;border-radius:8px;
    padding:8px 10px;color:#e2e8f0;font-size:.85rem;outline:none}
  input:focus,textarea:focus{border-color:#a78bfa}
  textarea{resize:vertical;min-height:80px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{flex:1;min-width:120px;padding:10px 12px;border:none;border-radius:8px;
    font-size:.85rem;font-weight:600;cursor:pointer;transition:.15s}
  .btn-purple{background:#7c3aed;color:#fff}
  .btn-purple:hover{background:#a78bfa}
  .btn-green{background:#22c55e;color:#fff}
  .btn-green:hover{background:#4ade80}
  .btn-red{background:#ef4444;color:#fff}
  .btn-red:hover{background:#f87171}
  .btn-gray{background:#334155;color:#e2e8f0}
  .btn-gray:hover{background:#475569}
  button:disabled{opacity:.4;cursor:not-allowed}
  .status-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:8px}
  .status-item{background:#0f172a;border-radius:8px;padding:8px;font-size:.78rem;
    display:flex;align-items:center;gap:6px}
  .dot{display:inline-block;width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .dot-ok{background:#22c55e}
  .dot-err{background:#ef4444}
  .dot-idle{background:#64748b}
  .dot-warn{background:#f59e0b}
  .dot-pulse{background:#a78bfa;animation:pulse 1s ease-in-out infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
  #camPreview{width:100%;max-height:200px;border-radius:8px;background:#000;object-fit:cover}
  #logBox{font-size:.75rem;color:#94a3b8;height:120px;overflow-y:auto;
    background:#0f172a;padding:8px;border-radius:6px;margin-top:8px}
  .timer{font-size:1rem;font-weight:700;color:#fbbf24;text-align:center;margin-top:4px}
  .ai-speech{background:#1e1b4b;border:1px solid #4c1d95;border-radius:8px;padding:8px;
    font-size:.8rem;color:#c4b5fd;min-height:40px;margin-top:8px;word-break:break-all}
</style>
</head>
<body>
<h1>ğŸ¯ ç©å®¶ç«¯ â€“ Gemini Live</h1>

<!-- API Key & Player Info -->
<div class="card">
  <label>Gemini API Key</label>
  <input type="password" id="apiKey" placeholder="AIza..." autocomplete="off">
  <label style="margin-top:8px">ç©å®¶å/ç¼–å·ï¼ˆå¦‚ P1ï¼‰</label>
  <input type="text" id="playerName" value="P1" maxlength="20">
  <label style="margin-top:8px">æ¨¡å‹ (é»˜è®¤å¯ä¸æ”¹)</label>
  <input type="text" id="modelId" value="models/gemini-2.5-flash-native-audio-preview-12-2025">
</div>

<!-- Player Prompt with connection code -->
<div class="card">
  <label>è¿æ¥ç ï¼ˆç²˜è´´è£åˆ¤é¡µç”Ÿæˆçš„è¿æ¥ç ï¼‰</label>
  <div style="display:flex;gap:8px;margin-bottom:10px">
    <input type="text" id="connCodeInput" placeholder="ç²˜è´´è¿æ¥ç ..." style="flex:1;font-family:monospace;font-size:.75rem">
    <button class="btn-purple" id="btnImportCode" style="flex:0 0 auto;min-width:60px">å¯¼å…¥</button>
  </div>
  <label>ç©å®¶ Prompt</label>
  <textarea id="playerPrompt">ä½ æ˜¯æˆ‘çš„çœ¼ç›ä¸å¯¼èˆªï¼Œåªç”¨ä¸­æ–‡çŸ­å¥ã€‚
æˆ‘å·²è’™çœ¼ï¼Œä½ å¿…é¡»ä¼˜å…ˆå®‰å…¨ï¼šè®©æˆ‘æ…¢èµ°ã€éšæ—¶åœä¸‹ã€åŒæ‰‹å‰æ¢ï¼›é‡åˆ°ä¸ç¡®å®šå¿…é¡»è®©æˆ‘åœã€‚
ç›®æ ‡ï¼šæ‰¾åˆ°å¹¶è§¦ç¢°å¥–æ¯ã€‚
æŒ‡ä»¤æ ¼å¼ï¼šæ–¹å‘ï¼‹å°æ­¥æ•°ï¼ˆä¾‹ï¼šã€Œå‘å·¦ä¸€æ­¥/å‘å‰ä¸¤å°æ­¥/å‘å³è½¬45åº¦ã€ï¼‰ã€‚
æ¯è¿‡10ç§’ç»™æˆ‘åšå‡ºä¸‹ä¸€æ­¥æŒ‡ç¤ºã€‚</textarea>
</div>

<!-- Camera preview (for angle check) -->
<div class="card">
  <label>æ‘„åƒå¤´é¢„è§ˆï¼ˆè°ƒæ•´è§’åº¦ï¼‰</label>
  <video id="camPreview" autoplay muted playsinline></video>
</div>

<!-- Status -->
<div class="card">
  <div class="status-grid">
    <div class="status-item"><span class="dot dot-idle" id="dotMic"></span>éº¦å…‹é£</div>
    <div class="status-item"><span class="dot dot-idle" id="dotCam"></span>æ‘„åƒå¤´</div>
    <div class="status-item"><span class="dot dot-idle" id="dotLive"></span>Live è¿æ¥</div>
    <div class="status-item"><span class="dot dot-idle" id="dotPlay"></span>AI éŸ³é¢‘</div>
  </div>
  <div class="timer" id="timerDisplay">00:00</div>
  <div class="ai-speech" id="aiSpeechBox">ï¼ˆAI æŒ‡ä»¤å°†æ˜¾ç¤ºåœ¨è¿™é‡Œï¼‰</div>
</div>

<!-- Controls -->
<div class="card">  <div class="row" style="align-items:center;margin-bottom:8px">
    <label style="margin:0;flex:0 0 auto">&#x1F4F9; è§†é¢‘å¸§ç‡</label>
    <select id="fpsSel" style="flex:1;background:#0f172a;border:1px solid #334155;border-radius:8px;
      padding:6px 10px;color:#e2e8f0;font-size:.85rem;margin-left:8px">
      <option value="2000">0.5 fpsï¼ˆçœæµé‡ï¼‰</option>
      <option value="1000" selected>1 fpsï¼ˆé»˜è®¤ï¼‰</option>
      <option value="500">2 fpsï¼ˆæ›´æµç•…ï¼‰</option>
    </select>
  </div>  <div class="row">
    <button class="btn-purple" id="btnAuth">æˆæƒéº¦å…‹é£ï¼‹æ‘„åƒå¤´</button>
  </div>
  <div class="row">
    <button class="btn-green" id="btnStart" disabled>ğŸ® è¿æ¥ Live å¹¶å¼€å§‹</button>
    <button class="btn-red"  id="btnStop"  disabled>â›” åœæ­¢</button>
  </div>
</div>

<!-- Log -->
<div class="card">
  <label>æ—¥å¿—</label>
  <div id="logBox"></div>
</div>

<script>
// â”€â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const apiKeyEl      = document.getElementById('apiKey');
const playerNameEl  = document.getElementById('playerName');
const modelIdEl     = document.getElementById('modelId');
const playerPromptEl  = document.getElementById('playerPrompt');
const connCodeInput   = document.getElementById('connCodeInput');
const btnImportCode   = document.getElementById('btnImportCode');
const camPreview      = document.getElementById('camPreview');
const logBox          = document.getElementById('logBox');
const timerDisplay    = document.getElementById('timerDisplay');
const aiSpeechBox     = document.getElementById('aiSpeechBox');

const btnAuth    = document.getElementById('btnAuth');
const btnStart   = document.getElementById('btnStart');
const btnStop    = document.getElementById('btnStop');

const dotMic  = document.getElementById('dotMic');
const dotCam  = document.getElementById('dotCam');
const dotLive = document.getElementById('dotLive');
const dotPlay = document.getElementById('dotPlay');

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws              = null;
let micStream       = null;
let camStream       = null;
let inputAudioCtx   = null;
let outputAudioCtx  = null;
let scriptProcessor = null;
let nextPlayTime    = 0;
let videoTimer      = null;
let timerInterval   = null;
let isRunning       = false;
let totalElapsed    = 0;

// â”€â”€â”€ Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, type='info'){
  const c={info:'#94a3b8',ok:'#4ade80',err:'#f87172',warn:'#fbbf24'};
  const d=new Date();
  const ts=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
  logBox.innerHTML+=`<span style="color:${c[type]||c.info}">[${ts}] ${msg}</span>\n`;
  logBox.scrollTop=logBox.scrollHeight;
}
function setDot(el,state){
  el.className='dot '+(state==='ok'?'dot-ok':state==='err'?'dot-err':state==='warn'?'dot-warn':state==='pulse'?'dot-pulse':'dot-idle');
}

// â”€â”€â”€ Connection Code Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnImportCode.onclick = () => {
  const code = connCodeInput.value.trim();
  if(!code){ alert('è¯·ç²˜è´´è¿æ¥ç '); return; }
  try{
    const decoded = decodeURIComponent(escape(atob(code)));
    playerPromptEl.value = decoded;
    connCodeInput.value = '';
    log('è¿æ¥ç å¯¼å…¥æˆåŠŸ','ok');
  }catch(e){
    log('è¿æ¥ç æ— æ•ˆ: '+e.message,'err');
  }
};

// â”€â”€â”€ Auth Mic + Cam â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnAuth.onclick = async () => {
  try{
    micStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,sampleRate:16000},video:false});
    setDot(dotMic,'ok');
    log('éº¦å…‹é£æˆæƒæˆåŠŸ','ok');
  }catch(e){ setDot(dotMic,'err'); log('éº¦å…‹é£æˆæƒå¤±è´¥:'+e.message,'err'); return; }

  try{
    camStream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'environment',width:{ideal:640},height:{ideal:480}},
      audio:false
    });
    camPreview.srcObject = camStream;
    setDot(dotCam,'ok');
    log('æ‘„åƒå¤´æˆæƒæˆåŠŸ','ok');
  }catch(e){ setDot(dotCam,'err'); log('æ‘„åƒå¤´æˆæƒå¤±è´¥:'+e.message,'err'); return; }

  btnStart.disabled = false;
  btnAuth.textContent = 'âœ… å·²æˆæƒ';
  btnAuth.disabled = true;
};

// â”€â”€â”€ Float32 â†’ Int16 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function float32ToInt16(f32){
  const int16 = new Int16Array(f32.length);
  for(let i=0;i<f32.length;i++){
    const s = Math.max(-1,Math.min(1,f32[i]));
    int16[i] = s < 0 ? s*32768 : s*32767;
  }
  return int16;
}

function arrayBufferToBase64(buf){
  let binary='';
  const bytes = new Uint8Array(buf);
  for(let i=0;i<bytes.length;i++) binary+=String.fromCharCode(bytes[i]);
  return btoa(binary);
}

// â”€â”€â”€ Mic Recording (PCM16 16kHz) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startMicCapture(){
  // Use default sample rate, then resample in software to 16kHz
  inputAudioCtx = new AudioContext();
  const nativeSR = inputAudioCtx.sampleRate;
  const ratio    = nativeSR / 16000;
  log(`AudioContext sampleRate=${nativeSR}, ratio=${ratio.toFixed(2)}`);

  const source = inputAudioCtx.createMediaStreamSource(micStream);
  // bufferSize=4096 â†’ ~85ms at 48kHz
  scriptProcessor = inputAudioCtx.createScriptProcessor(4096,1,1);
  // Route through a silent gain node (gain=0) so onaudioprocess fires
  // but mic audio is NOT played back through speakers (avoids echo)
  const silentGain = inputAudioCtx.createGain();
  silentGain.gain.value = 0;
  source.connect(scriptProcessor);
  scriptProcessor.connect(silentGain);
  silentGain.connect(inputAudioCtx.destination);

  scriptProcessor.onaudioprocess = (e) => {
    if(!ws||ws.readyState!==1) return;
    const inputData = e.inputBuffer.getChannelData(0); // float32, nativeSR

    // Downsample to 16000
    const outLength = Math.floor(inputData.length / ratio);
    const resampled = new Float32Array(outLength);
    for(let i=0;i<outLength;i++){
      resampled[i] = inputData[Math.floor(i*ratio)];
    }

    const int16   = float32ToInt16(resampled);
    const base64  = arrayBufferToBase64(int16.buffer);
    wsSend({realtimeInput:{audio:{data:base64, mimeType:'audio/pcm;rate=16000'}}});
  };
  setDot(dotMic,'pulse');
  log('éº¦å…‹é£æ•è·å·²å¯åŠ¨','ok');
}

function stopMicCapture(){
  if(scriptProcessor){ scriptProcessor.disconnect(); scriptProcessor=null; }
  if(inputAudioCtx){ inputAudioCtx.close(); inputAudioCtx=null; }
  setDot(dotMic,'ok');
}

// â”€â”€â”€ Audio Playback (PCM16 24kHz) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ensureOutputCtx(){
  if(!outputAudioCtx||outputAudioCtx.state==='closed'){
    outputAudioCtx = new AudioContext({sampleRate:24000});
    nextPlayTime = 0;
  }
  if(outputAudioCtx.state==='suspended') outputAudioCtx.resume();
}

function enqueueAudio(base64data){
  ensureOutputCtx();
  try{
    const bin   = atob(base64data);
    const bytes = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
    const samples = bytes.length/2;
    const buf = outputAudioCtx.createBuffer(1,samples,24000);
    const ch  = buf.getChannelData(0);
    const view= new DataView(bytes.buffer);
    for(let i=0;i<samples;i++) ch[i]=view.getInt16(i*2,true)/32768;
    const src = outputAudioCtx.createBufferSource();
    src.buffer = buf;
    src.connect(outputAudioCtx.destination);
    const t = Math.max(outputAudioCtx.currentTime+0.01, nextPlayTime);
    src.start(t);
    nextPlayTime = t + buf.duration;
    setDot(dotPlay,'pulse');
    src.onended = () => {
      if(Math.abs(nextPlayTime - (t+buf.duration)) < 0.05) setDot(dotPlay,'ok');
    };
  }catch(e){ log('éŸ³é¢‘æ’­æ”¾é”™è¯¯:'+e.message,'err'); }
}

function clearAudioQueue(){
  if(outputAudioCtx){ outputAudioCtx.close(); outputAudioCtx=null; nextPlayTime=0; }
  setDot(dotPlay,'idle');
}

// â”€â”€â”€ Video Frame Capture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const captureCanvas = document.createElement('canvas');
captureCanvas.width  = 320;
captureCanvas.height = 240;
const capCtx        = captureCanvas.getContext('2d');

function startVideoCapture(){
  const interval = parseInt(document.getElementById('fpsSel').value)||1000;
  videoTimer = setInterval(()=>{
    if(!camStream||!ws||ws.readyState!==1) return;
    if(!camPreview.videoWidth||!camPreview.videoHeight) return; // not ready yet
    capCtx.drawImage(camPreview, 0, 0, 320, 240);
    const jpeg   = captureCanvas.toDataURL('image/jpeg', 0.5);
    const base64 = jpeg.split(',')[1];
    wsSend({realtimeInput:{video:{data:base64, mimeType:'image/jpeg'}}});
  }, interval); // controlled by fps selector
}

function stopVideoCapture(){
  clearInterval(videoTimer); videoTimer=null;
}

// â”€â”€â”€ Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let gameStartTime = null;
function startTimer(){
  gameStartTime = Date.now() - totalElapsed*1000;
  timerInterval = setInterval(()=>{
    const s = Math.floor((Date.now()-gameStartTime)/1000);
    totalElapsed = s;
    const m = Math.floor(s/60);
    timerDisplay.textContent=`${String(m).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
  },500);
}
function stopTimer(){ clearInterval(timerInterval); timerInterval=null; }

// â”€â”€â”€ WebSocket helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function wsSend(obj){
  if(ws&&ws.readyState===1) ws.send(JSON.stringify(obj));
}

// â”€â”€â”€ Live Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectLive(){
  const key   = apiKeyEl.value.trim();
  const model = modelIdEl.value.trim()||'models/gemini-2.5-flash-native-audio-preview-12-2025';
  const name  = playerNameEl.value.trim()||'Player';
  const prompt= playerPromptEl.value.trim();
  if(!key){alert('è¯·è¾“å…¥ API Key');return;}

  const systemText = `ç©å®¶æ˜¯ ${name}ã€‚${prompt}`;

  const url = `wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1beta.GenerativeService.BidiGenerateContent?key=${encodeURIComponent(key)}`;
  ws = new WebSocket(url);
  setDot(dotLive,'warn');
  log('æ­£åœ¨è¿æ¥ Live...','warn');

  ws.onopen = () => {
    setDot(dotLive,'ok');
    log('WebSocket å·²è¿æ¥','ok');
    wsSend({
      setup:{
        model,
        generationConfig:{
          responseModalities:['AUDIO'],
          mediaResolution:'MEDIA_RESOLUTION_LOW',
          speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName:'Aoede'}}},
          thinkingConfig:{thinkingBudget:0}
        },
        systemInstruction:{parts:[{text:systemText}]}
      }
    });
    log('å·²å‘é€ setup','ok');
    startMicCapture();
    startVideoCapture();
  };

  ws.onmessage = async (evt) => {
    let data = evt.data;
    if(data instanceof Blob) data = await data.text();
    let msg;
    try{ msg=JSON.parse(data); }catch(e){ log('JSONè§£æå¤±è´¥: '+e.message,'err'); return; }

    if(msg.error){
      log('APIé”™è¯¯ '+msg.error.code+': '+msg.error.message,'err');
      return;
    }
    if(msg.serverContent?.interrupted){
      clearAudioQueue();
      return;
    }
    if(msg.serverContent?.modelTurn?.parts){
      for(const part of msg.serverContent.modelTurn.parts){
        if(part.inlineData?.mimeType?.startsWith('audio/')){
          enqueueAudio(part.inlineData.data);
        }
        if(part.text){
          log('AI: '+part.text,'ok');
          aiSpeechBox.textContent = part.text;
        }
      }
    }
    if(msg.setupComplete){
      log('Setup å®Œæˆï¼ŒLive å°±ç»ª','ok');
      wsSend({clientContent:{turns:[{role:'user',parts:[{text:'æ¸¸æˆå³å°†å¼€å§‹ï¼Œæˆ‘å·²è’™çœ¼ï¼Œè¯·å‡†å¤‡å¥½ç»™æˆ‘å¯¼èˆªã€‚'}]}],turnComplete:true}});
    }
  };

  ws.onerror = ()=>{ setDot(dotLive,'err'); log('WS é”™è¯¯','err'); };
  ws.onclose = (e)=>{
    setDot(dotLive,'idle');
    stopMicCapture();
    stopVideoCapture();
    log(`WS å·²å…³é—­ (code=${e.code})`, e.code===1000?'info':'warn');
    // Reconnect whenever isRunning (covers both server-side 2-min timeout
    // which sends code=1000, and unexpected errors)
    if(isRunning){
      log('3ç§’åè‡ªåŠ¨é‡è¿...','warn');
      setTimeout(()=>connectLive(),3000);
    }
  };
}

// â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnStart.onclick = () => {
  isRunning    = true;
  totalElapsed = 0;
  connectLive();
  startTimer();
  btnStart.disabled = true;
  btnStop.disabled  = false;
};

btnStop.onclick = () => {
  isRunning = false;
  stopMicCapture();
  stopVideoCapture();
  stopTimer();
  if(ws){ ws.close(1000,'user stop'); ws=null; }
  clearAudioQueue();
  setDot(dotLive,'idle');
  setDot(dotMic,'ok');
  btnStart.disabled = false;
  btnStop.disabled  = true;
  log('å·²åœæ­¢','warn');
};

// â”€â”€â”€ Persist API key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
apiKeyEl.value = localStorage.getItem('gemini_api_key')||'';
apiKeyEl.addEventListener('input',()=>localStorage.setItem('gemini_api_key',apiKeyEl.value));

log('ç©å®¶ç«¯å°±ç»ªã€‚è¯·å…ˆè¾“å…¥ API Key â†’ æˆæƒéº¦å…‹é£+æ‘„åƒå¤´ â†’ è¿æ¥ Liveã€‚','ok');
</script>
</body>
</html>
